<html>
    <head>
        <title>I'm having an Arcball</title>

        <!-- FIXME: full screen not working 2019-06-23 15:55:49 -->
		<!-- <style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
        </style> -->

        <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/84/three.min.js"></script>
        <script src="js/arcball_tentative.js"></script>

        <!-- FIXME: zoom controls 2019-06-23 15:57:34 -->
        <script type="module" src="js/OrbitControls.js"></script>
        
        <script>
            var canvas, scene, renderer, camera;
            var raycaster = new THREE.Raycaster();;
            // var ground; // A square base on which the boxs stand.
            var box, ball, inBall, ultraBall;
            var world;
            var ROTATE = 1, DRAG = 2, ADD = 3, DELETE = 4;
            var mouseAction;
            var dragItem;
            var intersects;
            var targetForDragging;  
        
            function createWorld() {
                scene = new THREE.Scene();
                renderer.setClearColor(0x333333);
                camera = new THREE.PerspectiveCamera(27,canvas.width/canvas.height,0.1,1000);
                camera.position.z = 60;
                camera.position.y = 30;
                camera.lookAt( new THREE.Vector3(0,0,0) );
                camera.add(new THREE.PointLight(0xffffff,0.7)); // point light at camera position
                scene.add(camera);
                scene.add(new THREE.DirectionalLight(0xffffff,0.5)); // light shining from above.
        
                world = new THREE.Object3D();
                scene.add(world);

                // FIXME: enable scroll to zoom 2019-06-23 17:18:39
                // var orbit = new THREE.OrbitControls(camera, renderer.domElement);
                // orbit.enableZoom = true;
                // orbit.enableRotate = false;
        
                targetForDragging = new THREE.Mesh(new THREE.BoxGeometry(100,0.01,100), new THREE.MeshBasicMaterial());
                targetForDragging.material.visible = false;

                box = new THREE.Mesh(new THREE.BoxGeometry(3, 6, 3), new THREE.MeshLambertMaterial({color:"yellow"}));
                box.position.y = 3;
                box.castShadow = true;

                addBox(10,10);
                addBox(0,15);
                addBox(-15,-7);
                addBox(-8,5);
                addBox(5,-12);
            }
        
            function addBox(x, z) {
                var obj = box.clone();
                obj.position.x = x;
                obj.position.z = z;
                world.add(obj);
            }

            function addBall(box) {
                box.geometry.computeBoundingSphere();
                var radius = box.geometry.boundingSphere.radius + 1;
                if (ball && box.position.distanceTo(ball.position) < 0.1) { return true; }
                if (ball) {
                    world.add(inBall);
                    world.remove(ball);
                } 
                ball = new THREE.Mesh(new THREE.SphereGeometry(radius, 32, 32), new THREE.MeshLambertMaterial({color:"red", transparent: true, opacity: 0.3}));
                inBall = box.clone();
                ball.position.copy(box.position);
                box.position.copy(new THREE.Vector3(0, 0, 0));
                world.remove(box);
                ball.add(box);
                world.add(ball);
            }
        
            function doMouseDown(x,y) {
                if (targetForDragging.parent == world) {
                    world.remove(targetForDragging);
                }
                var a = 2*x/canvas.width - 1;
                var b = 1 - 2*y/canvas.height;
                raycaster.setFromCamera(new THREE.Vector2(a,b), camera);
                intersects = raycaster.intersectObjects(world.children);
                if (intersects.length == 0) {
                    // FIXME: addition of new objects 2019-06-23 17:29:02
                    // if (mouseAction == ADD) {
                        // var locationX = x;  // Gives the point of intersection in world coords
                        // var locationZ = z;
                        // var coords = new THREE.Vector3(locationX, 0, locationZ);
                        // world.worldToLocal(coords);  // to add cylider in correct position, neew local coords for the world object
                        // addBox(coords.x, coords.z);
                        // renderer.render(scene,camera);
                    // }
                    return false;
                }
                var item = intersects[0];
                var objectHit = item.object;
                switch (mouseAction) {
                    case ROTATE:
                        if (ultraBall) {

                        } else {
                            dragItem = objectHit;
                            addBall(dragItem);
                        }
                        world.add(targetForDragging);
                        targetForDragging.position.set(0, item.point.y, 0);
                        renderer.render(scene,camera);
                        return true;
                    case DRAG:
                        dragItem = objectHit;
                        console.log(dragItem.position);
                        world.add(targetForDragging);
                        targetForDragging.position.set(0,item.point.y,0);
                        renderer.render(scene,camera);
                        return true;
                    case ADD:
                        var locationX = x;
                        var locationZ = z;
                        var coords = new THREE.Vector3(locationX, 0, locationZ);
                        world.worldToLocal(coords);
                        addBox(coords.x, coords.z);
                        renderer.render(scene, camera);
                        return false;
                    default:
                        world.remove(objectHit);
                        renderer.render(scene, camera);
                        return false;
                }
            }
        
            function doMouseMove(x,y,evt,prevX,prevY) {
                if (mouseAction == ROTATE) {
                    var dx = x - prevX;
                    var dy = y - prevY;
                    if (ultraBall) { world.rotateY(dx/100); }
                    else {
                        dragItem.rotateY(dx/100);
                        inBall.rotateY(dx/100);
                        dragItem.rotateX(dy/100);
                        inBall.rotateX(dy/100);
                    }
                    renderer.render(scene,camera);
                }
                else {  // drag
                    var a = 2*x/canvas.width - 1;
                    var b = 1 - 2*y/canvas.height;
                    raycaster.setFromCamera( new THREE.Vector2(a,b), camera );
                    intersects = raycaster.intersectObject( targetForDragging ); 
                    if (intersects.length == 0) {
                        return;
                    }
                    var locationX = intersects[0].point.x;
                    var locationZ = intersects[0].point.z;
                    var coords = new THREE.Vector3(locationX, 0, locationZ);
                    world.worldToLocal(coords);
                    a = Math.min(19,Math.max(-19,coords.x));
                    b = Math.min(19,Math.max(-19,coords.z));
                    dragItem.position.set(a,3,b);
                    renderer.render(scene,camera);
                }
            }
            
            function doChangeMouseAction() {
                if (document.getElementById("mouseRotate").checked) { mouseAction = ROTATE; }
                else if (document.getElementById("mouseDrag").checked) { mouseAction = DRAG; }
                else if (document.getElementById("mouseAdd").checked) { mouseAction = ADD; }
                else { mouseAction = DELETE; }
            }

            function doDoubleClick(event) {
                var maxX = 0;
                var minX = 0;
                var maxZ = 0;
                var minZ = 0;
                world.remove(targetForDragging);
                console.log(world);
                world.children.forEach(i => {
                    if (i.geometry.type === "BoxGeometry") {
                        console.log(i.position.x, i.position.z);
                        maxX = Math.max(maxX, i.position.x);
                        minX = Math.min(minX, i.position.x);
                        maxZ = Math.max(maxZ, i.position.z);
                        minZ = Math.min(minZ, i.position.z);
                    }
                });
                world.add(targetForDragging);
                var radius = Math.max(maxX - minX, maxZ - minZ) / 2 + 6;
                if (ultraBall) { world.remove(ultraBall);}
                ultraBall = new THREE.Mesh(new THREE.SphereGeometry(radius, 32, 32), new THREE.MeshLambertMaterial({color:"blue", transparent: true, opacity: 0.3}));
                ultraBall.position = new THREE.Vector3(minX, radius, minZ);
                world.add(ultraBall);
            }
        
            function init() {
                try {
                    canvas = document.getElementById("maincanvas");
                    renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
                }
                catch (e) {
                    document.getElementById("canvas-holder").innerHTML="<p><b>Sorry, an error occurred:<br>" + e + "</b></p>";
                    return;
                }
                document.getElementById("mouseDrag").checked = true;
                mouseAction = DRAG;
                document.getElementById("mouseRotate").onchange = doChangeMouseAction;
                document.getElementById("mouseDrag").onchange = doChangeMouseAction;
                document.getElementById("mouseAdd").onchange = doChangeMouseAction;
                document.getElementById("mouseDelete").onchange = doChangeMouseAction;
                document.addEventListener('dblclick', doDoubleClick, false);
                createWorld();
                setUpMouseHander(canvas,doMouseDown,doMouseMove);
                renderer.render(scene,camera);
            }
        </script>
    </head>


    <body onload="init()">
        <div id="content">
            <p><b>Mouse Action:</b>
                <label><input type="radio" name="action" id="mouseRotate">Rotate</label>
                <label><input type="radio" name="action" id="mouseDrag">Drag</label>
                <label><input type="radio" name="action" id="mouseAdd">Add</label>
                <label><input type="radio" name="action" id="mouseDelete">Delete</label>
            </p>
            <div id="canvas-holder">
                <canvas id="maincanvas" width="1650" height="900"></canvas>
            </div>
        </div>
        <div id='grand'></div>
    </body>
</html>
